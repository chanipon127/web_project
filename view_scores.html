<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <title>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</title>
    <style>
    body {
      font-family: sans-serif;
      margin: 0;
      background: #f5f5f5;
    }

    .navbar {
      position: sticky;
      top: 0;
      background-color: #4c65af;
      padding: 12px 30px;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 999;
    }

    .navbar-left {
      display: flex;
      gap: 15px;
    }

    .navbar a {
      color: #fff;
      text-decoration: none;
      margin-right: 20px;
      font-weight: 500;
      padding: 8px 15px;
      border-radius: 5px;
      transition: all 0.3s ease;
    }

    .navbar a:hover {
      background-color: rgba(255, 255, 255, 0.2);
      color: #ffeb3b;
    }

    .container {
      max-width: 1000px;
      margin: 20px auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
    }

    h2 {
      margin-top: 0;
    }

    .readonly-info {
      margin-bottom: 15px;
      font-size: 16px;
    }

    .filters {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    select,
    button {
      padding: 5px 10px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      vertical-align: top;
    }

    th {
      background-color: #e0e0e0;
    }

    .score {
      font-weight: bold;
      color: green;
    }

    .status {
      font-weight: bold;
    }

    .status.checked {
      color: green;
    }

    .status.unchecked {
      color: red;
    }

    pre {
      background: #eee;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
      text-align: left;
    }
  </style>
</head>

<body>

  <div class="navbar">
    <div class="navbar-left">
      <a href="homepage_user.html">HOME PAGE</a>
      <a href="check_exam.html">‡∏ï‡∏£‡∏ß‡∏à‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</a>
      <a href="view_scores.html">‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</a>
      <a href="profile_user.html">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</a>
      <a href="contect_admin.html">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</a>
      <a href="login.html">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
    </div>
  </div>

  <div class="container">
    <h2>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>

    <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏ö‡∏ö‡∏ü‡∏¥‡∏Å -->
    <div class="readonly-info">
      üìò <strong>‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤:</strong> <span id="displayYear"></span> |
      üè´ <strong>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô:</strong> <span id="displayGroup"></span>
    </div>

    <div class="filters">
      <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:
        <select id="statusFilter">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ --</option>
          <option value="‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß">‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß</option>
          <option value="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à</option>
        </select>
      </label>
   
      <label>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:
        <select id="student">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>
        </select>
      </label>
      <button onclick="loadStudentData()">‡∏î‡∏π‡∏ú‡∏•</button>
    </div>

    <p><strong>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</strong> <span id="studentId"></span></p>
    <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> <span id="status" class="status"></span></p>
    <p><strong>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°:</strong> <span id="score" class="score"></span></p>

    <h3>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
    <p><strong>‡∏Ç‡πâ‡∏≠ 1:</strong></p>
    <pre id="essayText"></pre>
    <p><strong>‡∏Ç‡πâ‡∏≠ 2:</strong></p>
    <pre id="essayAnalysis"></pre>

    <h3>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à (AI Feedback)</h3>
    <table>
      <thead>
        <tr>
          <th>‡∏Ç‡πâ‡∏≠</th>
          <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
          <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏£‡∏π 1</th>
          <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏£‡∏π 2</th>
          <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
        </tr>
      </thead>
      <tbody id="feedbackTable"></tbody>
    </table>
  </div>

  <script>
    let examYear = localStorage.getItem("exam_year");
    let examGrade = localStorage.getItem("exam_grade");

    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡πá‡∏ô
    document.getElementById("displayYear").textContent = examYear || "-";
    document.getElementById("displayGroup").textContent = examGrade || "-";

    let allData = [];

    // ‡πÇ‡∏´‡∏•‡∏î filters ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
    document.addEventListener("DOMContentLoaded", async () => {
      if (!examYear || !examGrade) {
        alert("‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö");
        window.location.href = "exam_setup.html";
        return;
      }

      try {
        const res = await fetch("http://127.0.0.1:8000/api/answers-all");
        if (!res.ok) throw new Error("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        allData = await res.json();

        // ‡∏ü‡∏¥‡∏Å‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        allData = allData.filter(d => d.exam_year == examYear && d.group_id == examGrade);

        const statusSelect = document.getElementById("statusFilter");
        const studentSelect = document.getElementById("student");

        // ‡πÇ‡∏´‡∏•‡∏î dropdown ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        studentSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>';
        allData.forEach(s => {
          const opt = document.createElement("option");
          opt.value = s.answer_id;
          opt.textContent = s.student_id;
          studentSelect.appendChild(opt);
        });

      } catch (err) {
        alert(err.message);
      }
    });


    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
    async function loadStudentData() {
      const answerId = document.getElementById("student").value;
      if (!answerId) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");
        return;
      }

      try {
        const res = await fetch(`http://127.0.0.1:8000/api/view-score/${answerId}`);
        if (!res.ok) throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ");
        const data = await res.json();

        // --- ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ---
        document.getElementById("studentId").textContent = data.student_id;
        document.getElementById("groupId").textContent = data.group_id;
        document.getElementById("examYear").textContent = data.exam_year;
        document.getElementById("status").textContent = data.status;
        document.getElementById("status").className = "status " + (data.status === '‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß' ? 'checked' : 'unchecked');
        document.getElementById("essayText").textContent = data.essay_text || "";
        document.getElementById("essayAnalysis").textContent = data.essay_analysis || "";

        // ========== ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• JSON ==========
        let parsedDescription = {};
        try {
          if (data.description) {
            parsedDescription = typeof data.description === 'string' ? JSON.parse(data.description) : data.description;
          }
          console.log("‚úÖ Parsed description:", parsedDescription);
        } catch (e) {
          console.error("‚ùå Error parsing description:", e);
        }

        // üî• ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å feedback)
        Object.keys(parsedDescription).forEach(key => {
          const item = parsedDescription[key];

          if (item.score === 0 && item.feedback) {
            try {
              const feedbackObj = typeof item.feedback === 'string' ? JSON.parse(item.feedback) : item.feedback;

              if (key === 's1' && feedbackObj['‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°'] != null) {
                item.score = parseFloat(feedbackObj['‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°']);
                console.log(`üîß ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ${key}: 0 ‚Üí ${item.score}`);
              }

              if (key === 's8' && feedbackObj.score_total != null) {
                item.score = parseFloat(feedbackObj.score_total);
                console.log(`üîß ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ${key}: 0 ‚Üí ${item.score}`);
              }

              if ((key === 's3' || key === 's10') && feedbackObj.score != null && item.score === 0) {
                item.score = parseFloat(feedbackObj.score);
                console.log(`üîß ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ${key}: 0 ‚Üí ${item.score}`);
              }

            } catch (e) {
              console.warn(`‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ parse feedback ‡∏Ç‡∏≠‡∏á ${key}:`, e);
            }
          }
        });

        let teacherScores = {};
        try {
          if (data.teacher_scores) {
            teacherScores = typeof data.teacher_scores === 'string' ? JSON.parse(data.teacher_scores) : data.teacher_scores;
          }
          console.log("‚úÖ Parsed teacherScores:", teacherScores);
        } catch (e) {
          console.error("‚ùå Error parsing teacher_scores:", e);
        }

        // üî• ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° AI
        let totalAIScore = 0;
        Object.keys(parsedDescription).forEach(key => {
          if (key.startsWith('s') && parsedDescription[key]?.score != null) {
            totalAIScore += parseFloat(parsedDescription[key].score);
          }
        });

        console.log("üìä ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° AI:", totalAIScore);
        document.getElementById("score").textContent = totalAIScore.toFixed(1);

        // ========== ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á ==========
        const feedbackTable = document.getElementById("feedbackTable");
        feedbackTable.innerHTML = "";

        const criteriaOrder = [
          { type: 'header', text: '--- ‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 1: ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏¢‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (10 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô) ---' },
          "s1", "s2", "s3", "s4", "s5", "s6",
          { type: 'summary', part: 1 },
          { type: 'header', text: '--- ‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 2: ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô (20 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô) ---' },
          "s7", "s8", "s9", "s10", "s11", "s12", "s13",
          { type: 'summary', part: 2 },
          { type: 'grand_total' }  // üî• ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        ];

        const criteriaNameMapping = {
          s1: '‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (4 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)',
          s2: '‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î (2 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)',
          s3: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏¢‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (1 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)',
          s4: '‡∏Å‡∏≤‡∏£‡∏™‡∏∞‡∏Å‡∏î‡∏Ñ‡∏≥ (1 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)',
          s5: '‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥/‡∏ñ‡πâ‡∏≠‡∏¢‡∏Ñ‡∏≥‡∏™‡∏≥‡∏ô‡∏ß‡∏ô (1 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)',
          s6: '‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ (1 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)',
          s7: '‡∏Ñ‡∏≥‡∏ö‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô (1 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)',
          s8: '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô (8 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)',
          s9: '‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î (3 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)',
          s10: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô (2 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)',
          s11: '‡∏Å‡∏≤‡∏£‡∏™‡∏∞‡∏Å‡∏î‡∏Ñ‡∏≥/‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤ (2 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)',
          s12: '‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥/‡∏ñ‡πâ‡∏≠‡∏¢‡∏Ñ‡∏≥‡∏™‡∏≥‡∏ô‡∏ß‡∏ô (2 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)',
          s13: '‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ (2 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)',
        };

        let totals = {
          ai: { part1: 0, part2: 0 },
          teacher1: { part1: 0, part2: 0 },
          teacher2: { part1: 0, part2: 0 }
        };

        criteriaOrder.forEach(item => {
          if (typeof item === 'object') {
            if (item.type === 'header') {
              const headerRow = document.createElement("tr");
              headerRow.innerHTML = `<td colspan="5" style="background-color: #e9ecef; font-weight: bold; text-align: center;">${item.text}</td>`;
              feedbackTable.appendChild(headerRow);
            }
            else if (item.type === 'summary') {
              const part = `part${item.part}`;
              const summaryRow = document.createElement("tr");
              summaryRow.style.background = "#f0f8ff";
              summaryRow.style.fontWeight = "bold";
              summaryRow.innerHTML = `
            <td>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${item.part}</td>
            <td class="score-cell score-ai">${totals.ai[part].toFixed(1)}</td>
            <td class="score-cell score-teacher">${totals.teacher1[part] > 0 ? totals.teacher1[part].toFixed(1) : '-'}</td>
            <td class="score-cell score-teacher">${totals.teacher2[part] > 0 ? totals.teacher2[part].toFixed(1) : '-'}</td>
            <td>-</td>
          `;
              feedbackTable.appendChild(summaryRow);
            }
            // üî• ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            else if (item.type === 'grand_total') {
              const grandTotalRow = document.createElement("tr");
              grandTotalRow.style.background = "#d4edda";
              grandTotalRow.style.fontWeight = "bold";
              grandTotalRow.style.fontSize = "16px";

              const totalAI = totals.ai.part1 + totals.ai.part2;
              const totalT1 = totals.teacher1.part1 + totals.teacher1.part2;
              const totalT2 = totals.teacher2.part1 + totals.teacher2.part2;

              grandTotalRow.innerHTML = `
            <td style="text-align: center; background-color: #28a745; color: white;">üèÜ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (30 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)</td>
            <td class="score-cell" style="background-color: #d1ecf1; color: #004085; font-size: 18px;">${totalAI.toFixed(1)}</td>
            <td class="score-cell" style="background-color: #d4edda; color: #155724; font-size: 18px;">${totalT1 > 0 ? totalT1.toFixed(1) : '-'}</td>
            <td class="score-cell" style="background-color: #d4edda; color: #155724; font-size: 18px;">${totalT2 > 0 ? totalT2.toFixed(1) : '-'}</td>
            <td style="background-color: #d4edda;">-</td>
          `;
              feedbackTable.appendChild(grandTotalRow);
            }
            return;
          }

          const sKey = item;
          const criteriaData = parsedDescription[sKey];

          if (criteriaData) {
            const criteriaName = criteriaNameMapping[sKey] || sKey;
            const aiScore = parseFloat(criteriaData.score ?? 0);

            const part = parseInt(sKey.substring(1)) <= 6 ? 'part1' : 'part2';
            totals.ai[part] += aiScore;

            const t1ScoreStr = teacherScores?.teacher1?.[sKey];
            const t2ScoreStr = teacherScores?.teacher2?.[sKey];
            const teacher1 = t1ScoreStr != null && t1ScoreStr !== '' ? parseFloat(t1ScoreStr).toFixed(1) : "-";
            const teacher2 = t2ScoreStr != null && t2ScoreStr !== '' ? parseFloat(t2ScoreStr).toFixed(1) : "-";

            if (teacher1 !== '-') totals.teacher1[part] += parseFloat(teacher1);
            if (teacher2 !== '-') totals.teacher2[part] += parseFloat(teacher2);

            let details = "-";
            if (criteriaData.feedback) {
              try {
                const feedbackObj = JSON.parse(criteriaData.feedback);
                details = JSON.stringify(feedbackObj, null, 2);
              } catch (e) {
                details = criteriaData.feedback;
              }
            }

            const row = document.createElement("tr");
            row.innerHTML = `
          <td>${criteriaName}</td>
          <td class="score-cell score-ai">${aiScore.toFixed(1)}</td>
          <td class="score-cell score-teacher">${teacher1}</td>
          <td class="score-cell score-teacher">${teacher2}</td>
          <td><pre>${details}</pre></td>
        `;
            feedbackTable.appendChild(row);
          }
        });

      } catch (error) {
        console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", error);
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
      }
    }
  </script>
</body>

</html>


